<!DOCTYPE html>

<html lang="ja">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Country Page</title>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      width: 100%;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: #ffffff;
      color: #1f1f1f;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    #captureArea {
      position: fixed;
      top: 0;
      left: -1vw;
      width: 102vw;
      height: 100vh;
      overflow: hidden;
      background: #ffffff;
    }

    #captureArea img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
      display: block;
      transform: translateY(-90px);
    }

    .user-name {
      position: absolute;
      bottom: 54px;
      left: 50%;
      max-width: 80vw;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.05em;
      color: #333333;
      pointer-events: none;
      text-align: center;
      word-break: break-all;
      overflow-wrap: anywhere;
      transform: translateX(-50%);
      font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }

    .timestamp {
      position: absolute;
      bottom: 36px;
      left: 50%;
      font-size: 13px;
      font-weight: 500;
      color: #6a6a6a;
      letter-spacing: 0.08em;
      pointer-events: none;
      text-align: center;
      transform: translateX(-50%);
      font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }

    .share-button {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 0;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      filter: drop-shadow(0 6px 18px rgba(0, 0, 0, 0.25));
    }

    .share-button:active {
      transform: translateY(1px);
    }

    .share-icon {
      width: 40px;
      height: 40px;
      pointer-events: none;
    }
  </style>

</head>

<body>

  <div id="captureArea">
    <img id="countryImage" src="asia/jp.svg" alt="Country Image">
    <div class="user-name" id="userName" aria-live="polite"></div>
    <div class="timestamp" id="timestamp" aria-live="polite"></div>
  </div>
  <button class="share-button" id="shareButton" type="button" aria-label="シェア">
    <img src="share.svg" alt="" class="share-icon">
  </button>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>

    (function () {

      const storedImage = sessionStorage.getItem('selectedImage') || localStorage.getItem('selectedImage');
      const storedName = sessionStorage.getItem('selectedName') || localStorage.getItem('selectedName');

      if (storedImage) {
        const imageElement = document.getElementById('countryImage');
        imageElement.src = storedImage;
      }

      const userNameElement = document.getElementById('userName');
      if (userNameElement) {
        if (storedName && storedName.trim().length > 0) {
          userNameElement.textContent = storedName;
        } else {
          userNameElement.textContent = '';
        }
      }

      const timestampElement = document.getElementById('timestamp');
      function updateTimestamp() {
        if (!timestampElement) return;
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        timestampElement.textContent = `${year}.${month}.${day} ${hours}:${minutes}:${seconds}`;
      }

      updateTimestamp();
      setInterval(updateTimestamp, 1000);

      const shareButton = document.getElementById('shareButton');
      const captureArea = document.getElementById('captureArea');

      async function captureCanvas() {
        return html2canvas(captureArea, {
          useCORS: true,
          backgroundColor: '#ffffff',
          scale: window.devicePixelRatio || 1,
          logging: false
        });
      }

      async function shareCapture() {
        if (!captureArea) {
          return;
        }
        try {
          const canvas = await captureCanvas();
          const cropRatio = 0.17;
          const cropCanvas = document.createElement('canvas');
          const cropWidth = Math.floor(canvas.width * (1 - cropRatio));
          const cropHeight = canvas.height;
          const cropStartX = Math.max(0, canvas.width - cropWidth);
          cropCanvas.width = cropWidth;
          cropCanvas.height = cropHeight;
          const cropCtx = cropCanvas.getContext('2d');
          if (cropCtx) {
            cropCtx.drawImage(
              canvas,
              cropStartX,
              0,
              cropWidth,
              cropHeight,
              0,
              0,
              cropWidth,
              cropHeight
            );
          }
          const blob = await new Promise((resolve, reject) => {
            cropCanvas.toBlob((result) => {
              if (result) {
                resolve(result);
              } else {
                reject(new Error('blob generation failed'));
              }
            }, 'image/png', 1.0);
          });
          if (!blob) {
            alert('画像の生成に失敗しました。');
            return;
          }
          const file = new File([blob], 'recommendation.png', { type: 'image/png' });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({ files: [file] });
          } else {
            const dataUrl = cropCanvas.toDataURL('image/png');
            const tempLink = document.createElement('a');
            tempLink.href = dataUrl;
            tempLink.download = 'recommendation.png';
            tempLink.click();
            alert('このブラウザでは直接共有できないため、画像を保存しました。');
          }
        } catch (error) {
          console.error('share failed', error);
          alert('共有に失敗しました。Safari を最新に更新し、もう一度お試しください。');
        }
      }

      if (shareButton) {
        shareButton.addEventListener('click', shareCapture);
      }

    })();

  </script>

</body>

</html>

